<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>cal</title>
  <style>
    :root {
      --bg: #f7f4ef;
      --panel: #fffdf8;
      --panel-2: #f3ede3;
      --text: #2e2e2e;
      --muted: #757575;
      --accent: #b88b5a;     /* warm neutral accent */
      --today: #e07a5f;      /* warm coral */
      --ring: rgba(0,0,0,0.08);
      --header-h: 48px;
      --gap: 8px;
      --radius: 10px;
      --shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: var(--bg);
      overflow: hidden;
    }

    .app {
      height: 100vh;
      width: 100vw;
      display: grid;
      grid-template-rows: var(--header-h) 1fr;
    }

    /* Sticky weekday header (Monday first) */
    .weekday-header {
      position: sticky;
      top: 0;
      z-index: 5;
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      align-items: center;
      border-bottom: 1px solid rgba(0,0,0,0.08);
      background: var(--panel);
      box-shadow: 0 1px 6px rgba(0,0,0,0.08);
    }
    .weekday-header .dayname {
      text-align: center;
      font-size: 13px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--muted);
      user-select: none;
    }

    /* Scroll container */
    .calendar-scroll {
      height: calc(100vh - var(--header-h));
      overflow: auto;
      padding: calc(var(--gap) * 1.5);
      scroll-behavior: smooth;
    }

    .weeks {
      display: flex;
      flex-direction: column;
      gap: var(--gap);
      min-height: 100%;
    }

    /* Each week row: baseline shows ~4 weeks; grows as needed if many tasks */
    .week {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: var(--gap);
      min-height: calc((100vh - var(--header-h) - 3 * var(--gap) - 2 * calc(var(--gap) * 1.5)) / 4);
      position: relative;
    }

    .day {
      position: relative;
      border-radius: var(--radius);
      background: var(--panel);
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.06);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .day:hover { outline: 2px solid var(--ring); }

    .date-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .date-num {
      font-weight: 600;
      font-size: 14px;
    }
    .out-month .date-num { color: var(--muted); }

    /* Today highlight */
    .today {
      border: 1px solid rgba(224,122,95,0.6);
      box-shadow: 0 0 0 2px rgba(224,122,95,0.25), var(--shadow);
    }
    .today .date-num::after {
      content: " Today";
      font-size: 11px;
      font-weight: 700;
      margin-left: 6px;
      color: white;
      background: var(--today);
      padding: 2px 6px;
      border-radius: 999px;
    }

    .month-pill {
      position: absolute;
      left: 10px;
      bottom: 10px;
      font-size: 12px;
      color: var(--accent);
      background: rgba(184,139,90,0.12);
      border: 1px solid rgba(184,139,90,0.35);
      padding: 4px 8px;
      border-radius: 999px;
      z-index: 2;
    }

    .week.has-new-month::before {
      content: attr(data-month-label);
      position: absolute;
      transform: translateY(-50%);
      left: 16px;
      font-size: 32px;
      font-weight: 700;
      line-height: 1;
      color: rgba(0,0,0,0.05);
      pointer-events: none;
    }

    /* Tasks list */
    .tasks { display: flex; flex-direction: column; gap: 4px; }

    .task {
      display: grid;
      grid-template-columns: 28px 1fr;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.06);
      background: var(--panel-2);
      cursor: pointer;
      user-select: none;
    }
    .task[draggable="true"] { cursor: grab; }
    .task.dragging { opacity: 0.6; cursor: grabbing; }
    .task.selected { outline: 2px solid var(--accent); }

    /* Better, bigger checkbox with easy click target */
    .check-wrap {
      position: relative;
      width: 28px; height: 28px;
      border-radius: 8px;
      display: grid; place-items: center;
      cursor: pointer;
    }
    .check {
      position: absolute;
      opacity: 0; pointer-events: none; /* hide native */
    }
    .check-box {
      width: 18px; height: 18px;
      border: 2px solid #a78b71;
      border-radius: 5px;
      display: grid; place-items: center;
      transition: box-shadow .12s ease, background .12s ease, border-color .12s ease;
      box-shadow: 0 1px 0 rgba(0,0,0,0.04);
      background: #fff;
    }
    .check-box::after {
      content: "";
      width: 10px; height: 10px;
      border-radius: 2px;
      transform: scale(0);
      transition: transform .12s ease;
      background: #a78b71;
    }
    .check:checked + .check-box { background: #efe6db; border-color: #a78b71; }
    .check:checked + .check-box::after { transform: scale(1); }
    .check-wrap:hover .check-box { box-shadow: 0 0 0 3px rgba(167,139,113,0.20); }

    .task.completed {
      color: #9a9a9a;
      background: #f0f0f0;
      border-style: dashed;
    }
    /* preview gray when hovering the checkbox */
    .task.preview-complete { color: #9a9a9a; background: #f0f0f0; border-style: dashed; }

    .day.drag-over { outline: 2px dashed var(--accent); }

    /* Scrollbars */
    .calendar-scroll::-webkit-scrollbar { width: 8px; }
    .calendar-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 999px; }
    .calendar-scroll::-webkit-scrollbar-track { background: transparent; }

    /* Back to Today button */
    #backToToday {
      position: fixed;
      bottom: -60px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 16px;
      font-size: 14px;
      background: var(--today);
      color: white;
      border: none;
      border-radius: 999px;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: bottom 0.3s ease;
      z-index: 10;
    }
    #backToToday.show { bottom: 20px; }

    /* Dialog */
    .dialog-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.3);
      display: none; /* flex when open */
      justify-content: center; align-items: center;
      z-index: 20;
    }
    .dialog {
      background: #fff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      display: flex; flex-direction: column; gap: 10px;
      min-width: 280px; max-width: 90vw;
    }
    .dialog h3 { margin: 0; font-size: 16px; }
    .dialog input[type="text"] {
      padding: 8px; font-size: 14px;
      border: 1px solid #ccc; border-radius: 8px;
    }
    .color-options { display: flex; gap: 8px; }
    .color-option {
      width: 22px; height: 22px; border-radius: 50%;
      border: 2px solid transparent; cursor: pointer;
    }
    .color-option.selected { border-color: #333; }
    .dialog-actions { display: flex; gap: 8px; justify-content: flex-end; }
    .btn {
      background: #eee; border: none; padding: 8px 10px; border-radius: 8px; cursor: pointer;
    }
    .btn.primary { background: var(--accent); color: white; }
    .day.dimmed {
  opacity: 0.5;
}
  </style>
</head>
<body>
  <div class="app">
    <div class="weekday-header" aria-hidden="true">
      <div class="dayname">Mon</div>
      <div class="dayname">Tue</div>
      <div class="dayname">Wed</div>
      <div class="dayname">Thu</div>
      <div class="dayname">Fri</div>
      <div class="dayname">Sat</div>
      <div class="dayname">Sun</div>
    </div>

    <div id="scroll" class="calendar-scroll" role="region" aria-label="Infinite calendar">
      <div id="weeks" class="weeks"></div>
    </div>
  </div>

  <button id="backToToday">Back to Today</button>

  <!-- Dialog -->
  <div class="dialog-overlay" id="dialogOverlay">
    <div class="dialog" role="dialog" aria-modal="true">
      <h3 id="dialogTitle">Create task</h3>
      <input type="text" id="taskName" placeholder="Task name" />
      <div class="color-options" id="colorOptions">
        <div class="color-option" style="background:#f4b4b4" data-color="#f4b4b4"></div>
        <div class="color-option" style="background:#b4d6f4" data-color="#b4d6f4"></div>
        <div class="color-option" style="background:#c9f4b4" data-color="#c9f4b4"></div>
      </div>
      <div class="dialog-actions">
        <button class="btn" id="cancelBtn">Cancel</button>
        <button class="btn primary" id="createTaskBtn">Create Task</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Utilities =====
    function saveTasks() {
  const data = {
    autoId,
    tasks: Array.from(tasksById.values())
  };
  localStorage.setItem("calendarTasks", JSON.stringify(data));
}

function loadTasks() {
  const raw = localStorage.getItem("calendarTasks");
  if (!raw) return;
  try {
    const data = JSON.parse(raw);
    autoId = data.autoId || 1;
    (data.tasks || []).forEach(t => {
      // t.completed is already part of object
      insertTask(t);
    });
  } catch (e) {
    console.error("Failed to load tasks", e);
  }
}


    const fmtMonth = new Intl.DateTimeFormat(undefined, { month: 'long' });
    const fmtMonthShort = new Intl.DateTimeFormat(undefined, { month: 'short' });
    const fmtYear = new Intl.DateTimeFormat(undefined, { year: 'numeric' });

    const today = new Date();
    const todayKey = ymdKey(today);

    function ymdKey(d) {
        return d.getFullYear() + "-" +
        String(d.getMonth() + 1).padStart(2, "0") + "-" +
        String(d.getDate()).padStart(2, "0");
}
    function addDays(d, n) { const x = new Date(d); x.setDate(x.getDate() + n); return x; }
    function addWeeks(d, n) { return addDays(d, n * 7); }
    function startOfWeekMonday(d) {
      const tmp = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      let day = tmp.getDay(); if (day === 0) day = 7; // Sun->7
      tmp.setDate(tmp.getDate() - (day - 1));
      tmp.setHours(0,0,0,0);
      return tmp;
    }

    // ===== DOM refs =====
    const scrollEl = document.getElementById('scroll');
    const weeksEl = document.getElementById('weeks');
    const backToTodayBtn = document.getElementById('backToToday');

    // Dialog refs
    const dialogOverlay = document.getElementById('dialogOverlay');
    const taskNameInput = document.getElementById('taskName');
    const colorOptions = document.getElementById('colorOptions');
    const createTaskBtn = document.getElementById('createTaskBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const dialogTitle = document.getElementById('dialogTitle');

    // ===== Task store =====
    let autoId = 1;
    const tasksById = new Map();            // id -> task
    const tasksByDate = new Map();          // dateKey -> [ids]

    function ensureDateList(key) { if (!tasksByDate.has(key)) tasksByDate.set(key, []); }

    function insertTask(task) {
      tasksById.set(task.id, task);
      ensureDateList(task.dateKey);
      tasksByDate.get(task.dateKey).push(task.id);
      sortTasksForDate(task.dateKey);
      saveTasks();
    }
    function removeTask(task) {
      tasksById.delete(task.id);
      const list = tasksByDate.get(task.dateKey) || [];
      const i = list.indexOf(task.id); if (i>=0) list.splice(i,1);
      saveTasks();
    }
    function moveTask(task, newDateKey) {
      const oldKey = task.dateKey;
      if (oldKey === newDateKey) return;
      const oldList = tasksByDate.get(oldKey) || [];
      const idx = oldList.indexOf(task.id); if (idx>=0) oldList.splice(idx,1);
      ensureDateList(newDateKey);
      tasksByDate.get(newDateKey).push(task.id);
      task.dateKey = newDateKey;
      sortTasksForDate(oldKey);
      sortTasksForDate(newDateKey);
      saveTasks();
    }
    function sortTasksForDate(key) {
      const ids = tasksByDate.get(key) || [];
      ids.sort((a,b)=>{
        const A = tasksById.get(a), B = tasksById.get(b);
        // Incomplete first, then by created time
        if ((A.completed?1:0) !== (B.completed?1:0)) return (A.completed?1:0) - (B.completed?1:0);
        return A.createdAt - B.createdAt;
      });
    }

    // ===== Rendering weeks & days =====
    const initialWeek = startOfWeekMonday(today);
    const PRELOAD_WEEKS_EACH_SIDE = 52; // ~1 year each way
    let firstWeekStart, lastWeekStart;

    function renderInitial() {
      weeksEl.innerHTML = '';
      const start = addWeeks(initialWeek, -PRELOAD_WEEKS_EACH_SIDE);
      const end = addWeeks(initialWeek, PRELOAD_WEEKS_EACH_SIDE);
      firstWeekStart = new Date(start);
      lastWeekStart = new Date(end);

      const frag = document.createDocumentFragment();
      for (let w = 0; ; w++) {
        const weekStart = addWeeks(start, w);
        if (weekStart > end) break;
        frag.appendChild(renderWeek(weekStart));
      }
      weeksEl.appendChild(frag);

      // Center to today's week (one week above for context)
      requestAnimationFrame(() => {
        const weekEl = weeksEl.querySelector(`[data-week='${ymdKey(initialWeek)}']`);
        if (weekEl) {
          const weekHeight = weekEl.getBoundingClientRect().height;
          scrollEl.scrollTop = weekEl.offsetTop - weekHeight;
        }
      });
    }

    function renderWeek(weekStart) {
      const week = document.createElement('div');
      week.className = 'week';
      week.dataset.week = ymdKey(weekStart);

      let newMonthLabel = '';
      const refMonth = addDays(weekStart, 3).getMonth();

      for (let i = 0; i < 7; i++) {
        const d = addDays(weekStart, i);
        const dateKey = ymdKey(d);

        const day = document.createElement('div');
        day.className = 'day';
        day.dataset.date = dateKey;

        if (d.getMonth() !== refMonth) day.classList.add('out-month');
        if (dateKey === todayKey) day.classList.add('today');

        const dateRow = document.createElement('div');
        dateRow.className = 'date-row';
        const num = document.createElement('div');
        num.className = 'date-num';
        num.textContent = String(d.getDate());
        dateRow.appendChild(num);
        day.appendChild(dateRow);

        // New month tags
        if (d.getDate() === 1) {
          const pill = document.createElement('div');
          pill.className = 'month-pill';
          pill.textContent = `${fmtMonthShort.format(d)} ${fmtYear.format(d)}`;
          day.appendChild(pill);
          if (!newMonthLabel) newMonthLabel = `${fmtMonth.format(d)} ${fmtYear.format(d)}`;
        }

        // Tasks container
        const tasksWrap = document.createElement('div');
        tasksWrap.className = 'tasks';
        day.appendChild(tasksWrap);

                // Day click -> change active month & update highlight
        day.addEventListener('click', () => {
              const [y,m,d] = day.dataset.date.split("-").map(Number);
              activeMonth = y + "-" + String(m).padStart(2, "0"); // ✅ local month
 updateMonthHighlight();
        });

        // Day double click -> open create dialog if clicking empty space
        day.addEventListener('dblclick', (e) => {
          const isTask = e.target.closest && e.target.closest('.task');
          if (!isTask) openDialog(day, null);
        });

        // Drag-n-drop target
        day.addEventListener('dragover', (e)=>{ e.preventDefault(); day.classList.add('drag-over'); });
        day.addEventListener('dragleave', ()=> day.classList.remove('drag-over'));
        day.addEventListener('drop', (e)=>{
          e.preventDefault(); day.classList.remove('drag-over');
          const id = e.dataTransfer.getData('text/plain');
          const task = tasksById.get(Number(id));
          if (task) {
            const oldKey = task.dateKey;
            moveTask(task, dateKey);
            renderTasksForDate(oldKey);
            renderTasksForDate(dateKey);
          }
        });

        // Render any existing tasks for this date
        renderTasksIntoDay(day, dateKey);

        week.appendChild(day);
      }

      if (newMonthLabel) {
        week.classList.add('has-new-month');
        week.setAttribute('data-month-label', newMonthLabel);
      }

      return week;
    }

    function renderTasksIntoDay(dayEl, dateKey) {
      const wrap = dayEl.querySelector('.tasks');
      wrap.innerHTML = '';
      const ids = tasksByDate.get(dateKey) || [];
      ids.forEach(id => wrap.appendChild(buildTaskElement(tasksById.get(id))));
    }

    function renderTasksForDate(dateKey) {
      const dayEl = weeksEl.querySelector(`.day[data-date='${dateKey}']`);
      if (dayEl) renderTasksIntoDay(dayEl, dateKey);
    }

    function prependWeeks(count = 26) {
      const frag = document.createDocumentFragment();
      for (let i = count; i > 0; i--) {
        const wk = addWeeks(firstWeekStart, -1);
        frag.insertBefore(renderWeek(wk), frag.firstChild);
        firstWeekStart = wk;
      }
      weeksEl.insertBefore(frag, weeksEl.firstChild);
    }

    function appendWeeks(count = 26) {
      const frag = document.createDocumentFragment();
      for (let i = 0; i < count; i++) {
        const wk = addWeeks(lastWeekStart, 1);
        frag.appendChild(renderWeek(wk));
        lastWeekStart = wk;
      }
      weeksEl.appendChild(frag);
    }

    function trimOffscreen(maxKeep = 160) {
      const todayWeekKey = ymdKey(initialWeek); // keep the week containing today
      const weeks = weeksEl.children;
      if (weeks.length <= maxKeep) return;

      // Remove from top but never remove today's week
      while (weeks.length > maxKeep) {
        const first = weeks[0];
        if (first.dataset.week === todayWeekKey) break;
        const rect = first.getBoundingClientRect();
        const contRect = scrollEl.getBoundingClientRect();
        if (rect.bottom < contRect.top - 200) {
          weeksEl.removeChild(first);
          firstWeekStart = addWeeks(firstWeekStart, 1);
        } else break;
      }
      // Remove from bottom but never remove today's week
      while (weeks.length > maxKeep) {
        const last = weeks[weeks.length - 1];
        if (last.dataset.week === todayWeekKey) break;
        const rect = last.getBoundingClientRect();
        const contRect = scrollEl.getBoundingClientRect();
        if (rect.top > contRect.bottom + 200) {
          weeksEl.removeChild(last);
          lastWeekStart = addWeeks(lastWeekStart, -1);
        } else break;
      }
    }

    // Infinite scroll & back-to-today visibility
    let ticking = false;
    scrollEl.addEventListener('scroll', () => {
      if (ticking) return;
      window.requestAnimationFrame(() => {
        const nearTop = scrollEl.scrollTop < 500;
        const nearBottom = (scrollEl.scrollHeight - (scrollEl.scrollTop + scrollEl.clientHeight)) < 500;
        if (nearTop) {
          const oldHeight = scrollEl.scrollHeight;
          const oldTop = scrollEl.scrollTop;
          prependWeeks(26);
          const newHeight = scrollEl.scrollHeight;
          scrollEl.scrollTop = oldTop + (newHeight - oldHeight);
        }
        if (nearBottom) appendWeeks(26);
        trimOffscreen();

        // Show/hide button based on whether today's cell is visible within the scroll container
        const todayEl = weeksEl.querySelector('.day.today');
        if (todayEl) {
          const tRect = todayEl.getBoundingClientRect();
          const cRect = scrollEl.getBoundingClientRect();
          const outOfView = (tRect.bottom < cRect.top) || (tRect.top > cRect.bottom);
          backToTodayBtn.classList.toggle('show', outOfView);
        }
        ticking = false;
      });
      ticking = true;
    }, { passive: true });

    backToTodayBtn.addEventListener('click', () => {
      const weekEl = weeksEl.querySelector(`[data-week='${ymdKey(initialWeek)}']`);
      if (weekEl) {
        weekEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });

    // ===== Tasks UI =====
    let selectedTaskId = null; // for deletion

    function buildTaskElement(task) {
      const el = document.createElement('div');
      el.className = 'task';
      el.dataset.id = task.id;
      el.draggable = true;
      el.style.borderLeft = `4px solid ${task.color}`;

      // custom checkbox with big hit area
      const label = document.createElement('label');
      label.className = 'check-wrap';
      const input = document.createElement('input');
      input.type = 'checkbox';
      input.className = 'check';
      input.checked = !!task.completed;
      const box = document.createElement('span');
      box.className = 'check-box';
      label.appendChild(input);
      label.appendChild(box);

      const text = document.createElement('div');
      text.className = 'task-text';
      text.textContent = task.name;

      if (task.completed) el.classList.add('completed');

      // Preview gray on hover of checkbox (without toggling)
      label.addEventListener('mouseenter', () => {
        if (!input.checked) el.classList.add('preview-complete');
      });
      label.addEventListener('mouseleave', () => {
        el.classList.remove('preview-complete');
      });

      // Checkbox toggle -> gray out & move to bottom
      input.addEventListener('change', () => {
  task.completed = input.checked;
  el.classList.toggle('completed', task.completed); // apply completed class
  el.classList.remove('preview-complete');
  sortTasksForDate(task.dateKey);
  renderTasksForDate(task.dateKey);
  saveTasks();   // ✅ save completed state
});

      // Select on single click (body only)
      el.addEventListener('click', (e) => {
        if (e.target === input || e.target === box || e.target === label) return; // ignore checkbox area
        document.querySelectorAll('.task.selected').forEach(n => n.classList.remove('selected'));
        el.classList.add('selected');
        selectedTaskId = task.id;
      });

      // Edit on double click
      el.addEventListener('dblclick', (e) => {
        e.stopPropagation();
        const dayEl = el.closest('.day');
        openDialog(dayEl, el);
        saveTasks();
      });

      // Drag behavior
      el.addEventListener('dragstart', (e) => {
        el.classList.add('dragging');
        e.dataTransfer.setData('text/plain', String(task.id));
      });
      el.addEventListener('dragend', () => el.classList.remove('dragging'));

      el.appendChild(label);
      el.appendChild(text);
      return el;
    }

    // Delete with Backspace when a task is selected and no input is focused
    document.addEventListener('keydown', (e) => {
      const activeTag = document.activeElement && document.activeElement.tagName;
      if (e.key === 'Backspace' && selectedTaskId && activeTag !== 'INPUT' && activeTag !== 'TEXTAREA') {
        const task = tasksById.get(selectedTaskId);
        if (task) {
          const dateKey = task.dateKey;
          removeTask(task);
          renderTasksForDate(dateKey);
          selectedTaskId = null;
          saveTasks();
        }
      }
    });

    // ===== Dialog logic =====
    let selectedColor = '#f4b4b4';
    let dialogDayEl = null;
    let editingTaskEl = null;

    function openDialog(dayEl, taskEl) {
      dialogDayEl = dayEl;
      editingTaskEl = taskEl;
      const dateKey = dayEl.dataset.date;
      dialogTitle.textContent = taskEl ? 'Edit task' : 'Create task';
      createTaskBtn.textContent = taskEl ? 'Save Changes' : 'Create Task';

      // Prefill
      if (taskEl) {
        const id = Number(taskEl.dataset.id);
        const t = tasksById.get(id);
        taskNameInput.value = t ? t.name : '';
        selectedColor = t ? t.color : selectedColor;
      } else {
        taskNameInput.value = '';
        selectedColor = '#f4b4b4';
      }

      // Reflect selected color
      [...colorOptions.children].forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.color === selectedColor);
      });

      dialogOverlay.style.display = 'flex';
      // Focus+select name field (auto-selected)
      saveTasks();
      requestAnimationFrame(() => { taskNameInput.focus(); taskNameInput.select(); });
    }

    function closeDialog() {
      dialogOverlay.style.display = 'none';
      dialogDayEl = null;
      editingTaskEl = null;
    }

    // Color choose
    colorOptions.addEventListener('click', (e) => {
      const opt = e.target.closest('.color-option');
      if (!opt) return;
      selectedColor = opt.dataset.color;
      [...colorOptions.children].forEach(o => o.classList.toggle('selected', o === opt));
    });

    // Confirm / Cancel
    createTaskBtn.addEventListener('click', confirmTask);
    cancelBtn.addEventListener('click', closeDialog);

    // Keyboard in dialog
    dialogOverlay.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeDialog();
      if (e.key === 'Enter') confirmTask();
    });

    // Click outside dialog closes
    dialogOverlay.addEventListener('click', (e) => {
      if (e.target === dialogOverlay) closeDialog();
    });

    function confirmTask() {
      if (!dialogDayEl) return;
      const name = taskNameInput.value.trim();
      if (!name) { taskNameInput.focus(); return; }
      const dateKey = dialogDayEl.dataset.date;

      if (editingTaskEl) {
        const id = Number(editingTaskEl.dataset.id);
        const t = tasksById.get(id);
        if (t) {
          t.name = name;
          t.color = selectedColor;
          renderTasksForDate(t.dateKey);
        }
      } else {
        const task = { id: autoId++, name, color: selectedColor, completed: false, dateKey, createdAt: Date.now() };
        insertTask(task);
        renderTasksForDate(dateKey);
      }
      saveTasks();
      closeDialog();
    }

    // ===== Kickoff =====
    loadTasks();
    renderInitial();
    // ===== Month highlighting =====
    let activeMonth = today.getFullYear() + "-" + String(today.getMonth() + 1).padStart(2, "0");

function updateMonthHighlight() {
  const allDays = weeksEl.querySelectorAll('.day');
  allDays.forEach(dayEl => {
    const [y,m,d] = dayEl.dataset.date.split("-").map(Number);
const date = new Date(y, m - 1, d); // local time, not UTC
    const ym = date.getFullYear() + "-" + String(date.getMonth() + 1).padStart(2, "0");
    if (ym === activeMonth) {
      dayEl.classList.remove('dimmed');
    } else {
      dayEl.classList.add('dimmed');
    }
  });
}

updateMonthHighlight();
tasksByDate.forEach((_, dateKey) => renderTasksForDate(dateKey));
  </script>
</body>
</html>
